<!DOCTYPE html>
<html lang="fa">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ØªÙˆÙ¾â€ŒØ¨Ø§Ø±ÙˆÙ†</title>

  <style>
*{
  margin:0;
  padding:0;
  box-sizing:border-box;
  font-family:'Vazirmatn',sans-serif;
}

body{
  background:#0f0d33;
  color:#fff;
  min-height:100vh;
  display:flex;
  flex-direction:column;
  align-items:center;
  overflow-x:hidden;
}

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€ Ø±Ø¯ÛŒÙ Ø¨Ø§Ù„Ø§ÛŒÛŒ: Ù…Ù†Ùˆ + Ù„ÙˆÚ¯Ùˆ â”€â”€â”€â”€â”€â”€â”€â”€â”€ */

#top-bar{
  width:100%;
  max-width:900px;
  padding:12px 16px 4px;
  display:flex;
  justify-content:space-between;
  align-items:center;
  gap:12px;
}

/* Ú†Ù¾: Ø´Ø§Ù¾ + Ø¯Ø±Ø¨Ø§Ø±Ù‡ Ù…Ø§ */
#top-left{
  display:flex;
  gap:10px;
}
.topBtn{
  border:none;
  padding:8px 16px;
  font-size:14px;
  border-radius:999px;
  cursor:pointer;
  color:#fff;
  background:#ff8c00;
  box-shadow:0 0 6px rgba(0,0,0,.4);
  white-space:nowrap;
}
#aboutBtn{
  background:#1abc9c;
}

/* Ø±Ø§Ø³Øª: Ù„ÙˆÚ¯Ùˆ + Ø¹Ù†ÙˆØ§Ù† */
#top-right{
  display:flex;
  justify-content:flex-end;
  flex:1;
}
#logoArea{
  display:flex;
  align-items:center;
  gap:10px;
  direction:rtl;
}
#gameLogo{
  width:48px;
  height:48px;
  border-radius:999px;
  object-fit:cover;
  box-shadow:0 0 8px rgba(0,0,0,.5);
}
#gameTitle{
  font-size:20px;
  font-weight:800;
  white-space:nowrap;
}

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€ Ø±Ø¯ÛŒÙ ÙˆØ¶Ø¹ÛŒØª: BEST / LVL / Ø§Ù…ØªÛŒØ§Ø² / Ø¯Ú©Ù…Ù‡â€ŒÙ‡Ø§ â”€â”€â”€â”€â”€â”€â”€â”€â”€ */

#status-bar{
  width:100%;
  max-width:900px;
  padding:0 16px 8px;
  display:flex;
  justify-content:center;
  align-items:center;
}

#status-inner{
  display:flex;
  align-items:center;
  justify-content:center;
  gap:16px;
  flex-wrap:nowrap;
}

#stats-row{
  display:flex;
  gap:10px;
  font-size:14px;
  white-space:nowrap;
}

#scoreLabel{
  font-size:20px;
  font-weight:700;
  white-space:nowrap;
}

#icons-row{
  display:flex;
  gap:8px;
}
.iconBtn{
  padding:6px 10px;
  border-radius:999px;
  font-size:18px;
  background:#262a7a;
  color:#fff;
  border:none;
  box-shadow:0 0 5px rgba(0,0,0,.4);
  cursor:pointer;
}

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€ Ø¨Ø§Ø²ÛŒ / Ú©Ø§Ù†ÙˆØ§Ø³ â”€â”€â”€â”€â”€â”€â”€â”€â”€ */

#game-container{
  width:100%;
  max-width:900px;
  flex:1;
  display:flex;
  justify-content:center;
  align-items:center;
  padding:0 12px;
}

canvas{
  width:100%;
  max-width:380px;
  background:#16103f;
  border-radius:14px;
  box-shadow:0 0 18px rgba(0,0,0,.7);
  margin-top:4px;
}

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€ Ù¾ÛŒØ§Ù… Ù¾Ø§ÛŒÛŒÙ† â”€â”€â”€â”€â”€â”€â”€â”€â”€ */

#bottom-bar{
  width:100%;
  max-width:900px;
  padding:8px 16px 16px;
  display:flex;
  justify-content:center;
}

#hint{
  width:100%;
  background:#1f2937;
  padding:10px 16px;
  border-radius:999px;
  font-size:14px;
  direction:rtl;
  text-align:right;
  opacity:.9;
}

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€ Ù¾Ø§Ù¾â€ŒØ¢Ù¾â€ŒÙ‡Ø§ â”€â”€â”€â”€â”€â”€â”€â”€â”€ */

.overlay{
  position:fixed;
  inset:0;
  background:rgba(0,0,0,.7);
  display:none;
  align-items:center;
  justify-content:center;
  z-index:10;
}

.box{
  background:#1e124f;
  padding:16px;
  border-radius:16px;
  width:90%;
  max-width:380px;
  text-align:right;
  direction:rtl;
  font-size:13px;
  line-height:1.7;
  color:#f9fafb;
  box-shadow:0 0 18px rgba(0,0,0,.8);
  position:relative;
}

.box h3{
  margin-bottom:8px;
  font-size:16px;
}

.closeBtn{
  width:100%;
  border:none;
  padding:7px 14px;
  border-radius:999px;
  background:#4444aa;
  color:#fff;
  margin-top:10px;
  cursor:pointer;
  box-shadow:0 0 8px rgba(0,0,0,.5);
}
.closeBtn:active{
  transform:scale(.97);
}

/* Ø¢ÛŒØªÙ…â€ŒÙ‡Ø§ÛŒ Ø´Ø§Ù¾ */
.shopItem{
  background:#24145f;
  padding:8px;
  border-radius:10px;
  margin:6px 0;
  display:flex;
  justify-content:space-between;
  align-items:center;
  font-size:13px;
  transition:transform .15s ease, box-shadow .15s ease;
}
.shopItem span{
  display:block;
}
.shopItem button{
  padding:4px 10px;
  border:0;
  border-radius:999px;
  background:#ff8c00;
  color:white;
  cursor:pointer;
  font-size:11px;
}
.shopItem.bought{
  transform:scale(1.03);
  box-shadow:0 0 14px rgba(46,204,113,.8);
}

#shopMessage{
  position:absolute;
  top:4px;
  left:12px;
  font-size:11px;
  color:#2ecc71;
  opacity:0;
  pointer-events:none;
}
.shopMessageVisible{
  animation:shopFlash 1s ease-out forwards;
}
@keyframes shopFlash{
  0%{opacity:0;transform:translateY(-4px);}
  20%{opacity:1;transform:translateY(0);}
  80%{opacity:1;}
  100%{opacity:0;transform:translateY(-6px);}
}

/* Ø¯Ú©Ù…Ù‡ Ù„ÛŒÙ†Ú© Ø¯Ø± Ø¯Ø±Ø¨Ø§Ø±Ù‡â€ŒÙ…Ø§ */
.linkButton{
  display:inline-block;
  margin-top:10px;
  padding:6px 14px;
  border-radius:999px;
  text-decoration:none;
  font-size:12px;
  background:#1abc9c;
  color:#fff;
  box-shadow:0 0 10px rgba(0,0,0,.5);
}

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€ Ù…ÙˆØ¨Ø§ÛŒÙ„ â”€â”€â”€â”€â”€â”€â”€â”€â”€ */

@media(max-width:480px){
  #gameLogo{width:42px;height:42px;}
  #gameTitle{font-size:18px;}
  canvas{max-width:330px;}
  #scoreLabel{font-size:18px;}
  .topBtn{padding:6px 12px;font-size:13px;}
  #status-inner{gap:10px;}
}
</style>
</head>

<body>

  <!-- Ø±Ø¯ÛŒÙ Ø¨Ø§Ù„Ø§: Ø´Ø§Ù¾ / Ø¯Ø±Ø¨Ø§Ø±Ù‡ + Ù„ÙˆÚ¯Ùˆ / Ø¹Ù†ÙˆØ§Ù† -->
  <div id="top-bar">
    <div id="top-left">
      <button id="shopBtn" class="topBtn">Ø´Ø§Ù¾</button>
      <button id="aboutBtn" class="topBtn">Ø¯Ø±Ø¨Ø§Ø±Ù‡ Ù…Ø§</button>
    </div>

    <div id="top-right">
      <div id="logoArea">
        <img
          id="gameLogo"
          src="https://cdnfa.com/irangiah/a9be/uploads/bazi/picsart-25-11-14-07-34-00-477.webp"
          alt="ØªÙˆÙ¾â€ŒØ¨Ø§Ø±ÙˆÙ†"
        />
        <div id="gameTitle">ØªÙˆÙ¾â€ŒØ¨Ø§Ø±ÙˆÙ†</div>
      </div>
    </div>
  </div>

  <!-- Ø±Ø¯ÛŒÙ ÙˆØ¶Ø¹ÛŒØª: BEST / LVL / Ø§Ù…ØªÛŒØ§Ø² / Ø¢ÛŒÚ©ÙˆÙ†â€ŒÙ‡Ø§ -->
  <div id="status-bar">
  <div id="status-inner">
    <div id="stats-row">
      <span>BEST: <span id="bestScore">0</span></span>
      <span>LVL: <span id="levelLabel">1</span></span>
    </div>

    <div id="scoreLabel">
      Ø§Ù…ØªÛŒØ§Ø²: <span id="currentScore">0</span>
    </div>

    <div id="icons-row">
      <button id="soundBtn" class="iconBtn">ğŸ”Š</button>
      <button id="pauseBtn" class="iconBtn">â¸</button>
    </div>
  </div>
</div>

  <!-- Ø¨Ø§Ø²ÛŒ -->
  <div id="game-container">
    <canvas id="game"></canvas>
  </div>

  <!-- Ù¾ÛŒØ§Ù… Ù¾Ø§ÛŒÛŒÙ† -->
  <div id="bottom-bar">
    <div id="hint">Ø¨Ø±Ø§ÛŒ Ù‡Ø¯Ùâ€ŒÚ¯ÛŒØ±ÛŒ Ù„Ù…Ø³ Ú©Ù† Ùˆ Ø²Ø§ÙˆÛŒÙ‡ Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù† ğŸ¯</div>
  </div>

  <!-- Ø´Ø§Ù¾ -->
  <div id="shopOverlay" class="overlay">
    <div class="box" id="shopBox">
      <h3>ÙØ±ÙˆØ´Ú¯Ø§Ù‡ ØªÙˆÙ¾â€ŒØ¨Ø§Ø±ÙˆÙ† ğŸ</h3>
      <div id="shopMessage"></div>

      <div class="shopItem" data-item-row="balls">
        <span>+3 ØªÙˆÙ¾ Ø¯Ø§Ø¦Ù…ÛŒ</span>
        <span>Ù‚ÛŒÙ…Øª: 450 Ø§Ù…ØªÛŒØ§Ø²</span>
        <button data-item="balls">Ø®Ø±ÛŒØ¯</button>
      </div>

      <div class="shopItem" data-item-row="damage">
        <span>Ø§ÙØ²Ø§ÛŒØ´ Ù‚Ø¯Ø±Øª ØªÙˆÙ¾ (Ù„ÙÙˆÙÙ„ +1)</span>
        <span>Ù‚ÛŒÙ…Øª: 750 Ø§Ù…ØªÛŒØ§Ø²</span>
        <button data-item="damage">Ø®Ø±ÛŒØ¯</button>
      </div>

      <div class="shopItem" data-item-row="bomb">
        <span>Ø§ÙØ²Ø§ÛŒØ´ Ø§Ø­ØªÙ…Ø§Ù„ Ø¨Ù„ÙˆÚ© Ø¨Ù…Ø¨ ğŸ’£</span>
        <span>Ù‚ÛŒÙ…Øª: 600 Ø§Ù…ØªÛŒØ§Ø²</span>
        <button data-item="bomb">Ø®Ø±ÛŒØ¯</button>
      </div>

      <button class="closeBtn" id="closeShop">Ø¨Ø³ØªÙ†</button>
    </div>
  </div>

  <!-- Ø¯Ø±Ø¨Ø§Ø±Ù‡ Ù…Ø§ -->
  <div id="aboutOverlay" class="overlay">
    <div class="box">
      <h3>Ø¯Ø±Ø¨Ø§Ø±Ù‡ Ø·Ø§ÙˆÛŒØªØ§</h3>
      <p>
        Ø·Ø§ÙˆÛŒØªØ§ ÛŒÚ© Ú©Ø§Ù†Ø§Ù„ Ø¢Ù…ÙˆØ²Ø´ ØªÙˆÙ„ÛŒØ¯ Ù…Ø­ØªÙˆØ§ Ùˆ Ù‡ÙˆØ´ Ù…ØµÙ†ÙˆØ¹ÛŒ Ø§Ø³Øª Ú©Ù‡ Ø¨Ø§ Ø±ÙˆÛŒÚ©Ø±Ø¯ÛŒ
        Ø­Ø±ÙÙ‡â€ŒØ§ÛŒ Ø§Ù…Ø§ ØµÙ…ÛŒÙ…ÛŒØŒ Ø¨Ù‡ Ø´Ù…Ø§ Ú©Ù…Ú© Ù…ÛŒâ€ŒÚ©Ù†Ø¯ Ù…Ø­ØªÙˆØ§ÛŒ Ù…Ø¤Ø«Ø±ØŒ Ø®Ù„Ø§Ù‚ Ùˆ
        Ø¯Ø±Ø¢Ù…Ø¯Ø²Ø§ Ø¨Ø³Ø§Ø²ÛŒØ¯.
      </p>
      <p>
        Ø¯Ø± Ú©Ù†Ø§Ø± Ø¢Ù…ÙˆØ²Ø´ØŒ ØªÛŒÙ… Ø·Ø§ÙˆÛŒØªØ§ Ø§Ù†Ø¬Ø§Ù… Ù¾Ø±ÙˆÚ˜Ù‡â€ŒÙ‡Ø§ÛŒ ØªØ®ØµØµÛŒ Ù…Ø«Ù„ Ø³Ø§Ø®Øª ÙˆÛŒØ¯Ø¦ÙˆØŒ
        Ø·Ø±Ø§Ø­ÛŒ Ø¨Ø§Ø²ÛŒØŒ ØªÙˆÙ„ÛŒØ¯ Ù…Ø­ØªÙˆØ§ÛŒ Ø´Ø¨Ú©Ù‡â€ŒÙ‡Ø§ÛŒ Ø§Ø¬ØªÙ…Ø§Ø¹ÛŒ Ùˆ Ø§Ø¬Ø±Ø§ÛŒ Ø§ÛŒØ¯Ù‡â€ŒÙ‡Ø§ÛŒ
        Ø®Ù„Ø§Ù‚Ø§Ù†Ù‡ Ø±Ø§ Ù†ÛŒØ² Ù…ÛŒâ€ŒÙ¾Ø°ÛŒØ±Ø¯.
      </p>
      <p>
        Ø¨Ø±Ø§ÛŒ Ù‡Ù…Ø±Ø§Ù‡ÛŒ Ø¨Ø§ Ø·Ø§ÙˆÛŒØªØ§ Ùˆ Ø¯ÛŒØ¯Ù† Ø¢Ù…ÙˆØ²Ø´â€ŒÙ‡Ø§ Ùˆ Ù¾Ø±ÙˆÚ˜Ù‡â€ŒÙ‡Ø§ØŒ Ù…ÛŒâ€ŒØªÙˆØ§Ù†ÛŒØ¯ Ø§Ø²
        Ø·Ø±ÛŒÙ‚ Ù„ÛŒÙ†Ú© Ø²ÛŒØ± Ø¹Ø¶Ùˆ Ú©Ø§Ù†Ø§Ù„ Ø´ÙˆÛŒØ¯:
      </p>
      <a class="linkButton" href="https://eitaa.com/tavita" target="_blank">
        ÙˆØ±ÙˆØ¯ Ø¨Ù‡ Ú©Ø§Ù†Ø§Ù„ Ø·Ø§ÙˆÛŒØªØ§ Ø¯Ø± Ø§ÛŒØªØ§
      </a>
      <button class="closeBtn" id="closeAbout">Ø¨Ø³ØªÙ†</button>
    </div>
  </div>

  <!-- Ú¯ÛŒÙ…â€ŒØ§ÙˆØ± -->
  <div id="gameOverOverlay" class="overlay">
    <div class="box" id="gameOverBox">
      <h3>Ù¾Ø§ÛŒØ§Ù† Ø¨Ø§Ø²ÛŒ ğŸ®</h3>
      <p id="gameOverScoreText">Ø§Ù…ØªÛŒØ§Ø² Ø´Ù…Ø§: 0</p>
      <p id="gameOverBestText" style="font-size:12px;opacity:.85;"></p>
      <p style="font-size:12px;opacity:.9;">Ù…ÛŒâ€ŒØªÙˆÙ†ÛŒ Ø¯ÙˆØ¨Ø§Ø±Ù‡ ØªÙ„Ø§Ø´ Ú©Ù†ÛŒ Ùˆ Ø±Ú©ÙˆØ±Ø¯ Ø®ÙˆØ¯Øª Ø±Ùˆ Ø¨Ø´Ú©Ù†ÛŒ ğŸ˜</p>
      <button class="closeBtn" id="retryBtn">Ø¯ÙˆØ¨Ø§Ø±Ù‡ ØªÙ„Ø§Ø´ Ú©Ù†</button>
    </div>
  </div>

  <!-- â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ Ø§Ø³Ú©Ø±ÛŒÙ¾Øª Ø¨Ø§Ø²ÛŒ (Ù‡Ù…ÙˆÙ† Ú©Ø¯ Ø®ÙˆØ¯Øª) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
  <script>
    const canvas = document.getElementById("game");
    const ctx = canvas.getContext("2d");

    let baseX, baseY;
    function resizeCanvas(){
      const w = Math.min(window.innerWidth * 0.98, 420);
      const h = Math.min(window.innerHeight * 0.75, 700);
      canvas.width = w;
      canvas.height = h;
      baseX = canvas.width / 2;
      baseY = canvas.height - 20;
    }
    resizeCanvas();
    window.addEventListener("resize", resizeCanvas);

    const scoreEl = document.getElementById("currentScore");
    const bestEl = document.getElementById("bestScore");
    const levelLabel = document.getElementById("levelLabel");
    const shopOverlay = document.getElementById("shopOverlay");
    const shopBtn = document.getElementById("shopBtn");
    const closeShopBtn = document.getElementById("closeShop");
    const aboutOverlay = document.getElementById("aboutOverlay");
    const aboutBtn = document.getElementById("aboutBtn");
    const closeAboutBtn = document.getElementById("closeAbout");
    const shopMessage = document.getElementById("shopMessage");
    const hintEl = document.getElementById("hint");

    const pauseBtn = document.getElementById("pauseBtn");
    const soundBtn = document.getElementById("soundBtn");

    const gameOverOverlay = document.getElementById("gameOverOverlay");
    const gameOverScoreText = document.getElementById("gameOverScoreText");
    const gameOverBestText = document.getElementById("gameOverBestText");
    const retryBtn = document.getElementById("retryBtn");

    let audioCtx;
    let isMuted = false;
    function playBeep(freq=600, dur=0.07){
      if(isMuted) return;
      try{
        if(!audioCtx) audioCtx = new (window.AudioContext||window.webkitAudioContext)();
        const osc = audioCtx.createOscillator();
        const gain = audioCtx.createGain();
        osc.frequency.value = freq;
        osc.type = "triangle";
        gain.gain.value = 0.08;
        osc.connect(gain);
        gain.connect(audioCtx.destination);
        osc.start();
        osc.stop(audioCtx.currentTime + dur);
      }catch(e){}
    }

    // ÙˆØ¶Ø¹ÛŒØª Ø¨Ø§Ø²ÛŒ
    let balls = [];
    let trails = [];
    let blocks = [];
    let powerUps = [];
    let isAiming = false;
    let aimX = 0, aimY = 0;
    let score = 0, bestScore = 0;
    let level = 1;
    let waves = 0;
    let numBalls = 25;
    let damagePerHit = 1;
    let bombChance = 0.08;
    let turnInProgress = false;
    let frame = 0;
    let shake = 0;
    let hintTimeout = null;
    let isPaused = false;
    let gameOver = false;

    const cols = 7;
    const padding = 6;

    const randInt = (min,max)=>Math.floor(Math.random()*(max-min+1))+min;

    function pickColor(type,v){
      if(type==="bomb") return "#a66bff";
      if(type==="ice") return "#66d9ff";
      if(type==="moving") return "#ffb347";
      if(type==="armor") return "#c084ff";
      if(v<12) return "#00bfff";
      if(v<20) return "#8a2be2";
      if(v<30) return "#ffd700";
      if(v<45) return "#ff8c00";
      return "#ff5555";
    }

    function spawnRow(){
      const blockWidth = (canvas.width - (cols+1)*padding)/cols;
      const blockHeight = blockWidth * .7;

      for(let c=0; c<cols; c++){
        if(Math.random() < 0.75){
          const x = padding + c*(blockWidth+padding);
          const y = padding;

          const base = 5 + (level * 3) + (waves * 2);
          const multiplier = 1 + (level * 0.15);
          const spread = 5 + level * 3;
          const val = Math.floor((base + randInt(0, spread)) * multiplier);

          let type = "normal";
          const r = Math.random();
          const effBombChance = (bombChance + level * 0.015);

          if(r < effBombChance) type = "bomb";
          else if(r < effBombChance + 0.05) type = "ice";
          else if(r < effBombChance + 0.10) type = "moving";
          else if(r < effBombChance + 0.15) type = "armor";

          blocks.push({
            x, y, w:blockWidth, h:blockHeight,
            value: val,
            type,
            hpExtra: type==="ice" ? 1 : (type==="armor" ? 2 : 0),
            color: pickColor(type, val),
            alive: true,
            vx: type === "moving" ? (Math.random()<0.5 ? -1 : 1) * (0.7 + level * 0.1) : 0
          });
        }
      }

      if(Math.random() < 0.55){
        const px = randInt(40, canvas.width - 40);
        const py = padding + blockHeight + 12;
        const types = ["extraBall","damageUp","bombUp"];
        powerUps.push({x:px,y:py,r:10,type:types[randInt(0,2)],collected:false});
      }
    }

    function moveBlocksDown(){
      const baseRowHeight = blocks.length ? (blocks[0].h + padding) : 40;

      const levelFactor = 1 + (level - 1) * 0.35;
      const waveFactor = 1 + Math.min(waves, 15) * 0.04;

      const moveAmount = baseRowHeight * levelFactor * waveFactor;

      for(const b of blocks) b.y += moveAmount;
      for(const p of powerUps) p.y += moveAmount;
    }

    function updateLabels(){
      scoreEl.textContent = score;
      bestEl.textContent = bestScore;
      levelLabel.textContent = level;
    }

    function resetGame(){
      balls=[]; trails=[]; blocks=[]; powerUps=[];
      score=0; level=1; waves=0;
      numBalls=25; damagePerHit=1; bombChance=0.08;
      turnInProgress=false; frame=0;
      shake=0; isPaused=false; gameOver=false;
      spawnRow();
      updateLabels();
    }

    resetGame();

    function shoot(angle){
      balls=[]; trails=[];
      const speed = 6 + level*0.4;
      for(let i=0;i<numBalls;i++){
        balls.push({
          x:baseX,y:baseY,
          vx:Math.cos(angle)*speed,
          vy:Math.sin(angle)*speed,
          delay:i*2,
          active:false,
          returned:false
        });
      }
      turnInProgress=true;
      frame=0;
      playBeep(650,0.09);
    }

    function getCanvasPos(evt){
      const rect = canvas.getBoundingClientRect();
      let clientX, clientY;
      if(evt.touches && evt.touches[0]){
        clientX = evt.touches[0].clientX;
        clientY = evt.touches[0].clientY;
      }else if(evt.changedTouches && evt.changedTouches[0]){
        clientX = evt.changedTouches[0].clientX;
        clientY = evt.changedTouches[0].clientY;
      }else{
        clientX = evt.clientX;
        clientY = evt.clientY;
      }
      const x = (clientX - rect.left) * (canvas.width / rect.width);
      const y = (clientY - rect.top)  * (canvas.height / rect.height);
      return {x,y};
    }

    let isAiming = false;
    function startAim(evt){
      if(turnInProgress || isPaused || gameOver) return;
      isAiming=true;
      const p = getCanvasPos(evt);
      aimX=p.x; aimY=p.y;
    }
    function moveAim(evt){
      if(!isAiming || isPaused || gameOver) return;
      const p = getCanvasPos(evt);
      aimX=p.x; aimY=p.y;
    }
    function endAim(){
      if(!isAiming || isPaused || gameOver) return;
      isAiming=false;
      let angle = Math.atan2(aimY-baseY, aimX-baseX);
      if(angle>-0.15) angle=-0.15;
      if(angle<-Math.PI+0.15) angle=-Math.PI+0.15;
      shoot(angle);
    }

    canvas.addEventListener("mousedown", e=>startAim(e));
    canvas.addEventListener("mousemove", e=>moveAim(e));
    canvas.addEventListener("mouseup",   ()=>endAim());

    canvas.addEventListener("touchstart", e=>{startAim(e); e.preventDefault();},{passive:false});
    canvas.addEventListener("touchmove",  e=>{moveAim(e); e.preventDefault();},{passive:false});
    canvas.addEventListener("touchend",   e=>{endAim();  e.preventDefault();},{passive:false});

    function showShopMsg(text){
      shopMessage.textContent = text;
      shopMessage.classList.remove("shopMessageVisible");
      void shopMessage.offsetWidth;
      shopMessage.classList.add("shopMessageVisible");
    }

    function flashHint(text){
      if(hintTimeout) clearTimeout(hintTimeout);
      const old = hintEl.textContent;
      hintEl.textContent = text;
      hintTimeout = setTimeout(()=>{hintEl.textContent = old;}, 3000);
    }

    shopBtn.onclick = ()=>{ if(!turnInProgress && !gameOver) shopOverlay.style.display="flex"; };
    closeShopBtn.onclick = ()=>shopOverlay.style.display="none";
    shopOverlay.addEventListener("click",e=>{
      if(e.target===shopOverlay) shopOverlay.style.display="none";
    });

    document.querySelectorAll(".shopItem button").forEach(btn=>{
      btn.addEventListener("click", ()=>{
        const item = btn.getAttribute("data-item");
        let cost = 0;
        if(item === "balls") cost = 450;
        else if(item === "damage") cost = 750;
        else if(item === "bomb") cost = 600;

        if(score < cost){
          showShopMsg("Ø§Ù…ØªÛŒØ§Ø² Ú©Ø§ÙÛŒ Ù†Ø¯Ø§Ø±ÛŒ ğŸ˜…");
          playBeep(200,0.1);
          return;
        }

        score -= cost;
        if(item==="balls"){
          numBalls += 3;
          flashHint("Û³ ØªÙˆÙ¾ Ø¨Ù‡ Ù…Ø¬Ù…ÙˆØ¹Ù‡â€ŒØ§Øª Ø§Ø¶Ø§ÙÙ‡ Ø´Ø¯ ğŸ¯");
        }else if(item==="damage"){
          damagePerHit += 1;
          flashHint("Ù‚Ø¯Ø±Øª ØªÙˆÙ¾â€ŒÙ‡Ø§ Ø¨ÛŒØ´ØªØ± Ø´Ø¯ ğŸ”¥");
        }else if(item==="bomb"){
          bombChance += 0.03;
          flashHint("Ø´Ø§Ù†Ø³ Ø¨Ù„ÙˆÚ©â€ŒÙ‡Ø§ÛŒ Ø¨Ù…Ø¨ Ø¨Ø§Ù„Ø§ØªØ± Ø±ÙØª ğŸ’£");
        }

        const row = document.querySelector(`.shopItem[data-item-row="${item}"]`);
        if(row){
          row.classList.add("bought");
          setTimeout(()=>row.classList.remove("bought"), 300);
        }

        showShopMsg("Ø®Ø±ÛŒØ¯ Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø§Ù†Ø¬Ø§Ù… Ø´Ø¯ âœ…");
        playBeep(900,0.12);
        updateLabels();
      });
    });

    // Ø¯Ø±Ø¨Ø§Ø±Ù‡ Ù…Ø§
    aboutBtn.onclick = ()=>{aboutOverlay.style.display="flex";};
    closeAboutBtn.onclick = ()=>{aboutOverlay.style.display="none";};
    aboutOverlay.addEventListener("click",e=>{
      if(e.target===aboutOverlay) aboutOverlay.style.display="none";
    });

    function applyPowerUp(type){
      if(type==="extraBall"){
        numBalls += 2;
        flashHint("Û² ØªÙˆÙ¾ Ø¬Ø§ÛŒØ²Ù‡ Ú¯Ø±ÙØªÛŒ! ğŸ˜");
      }else if(type==="damageUp"){
        damagePerHit += 1;
        flashHint("Ù‚Ø¯Ø±Øª Ø¶Ø±Ø¨Ù‡ ØªÙˆÙ¾â€ŒÙ‡Ø§ Ø¨ÛŒØ´ØªØ± Ø´Ø¯ ğŸ”¥");
      }else if(type==="bombUp"){
        bombChance += 0.03;
        flashHint("Ø§Ø² Ø­Ø§Ù„Ø§ Ø¨Ù…Ø¨â€ŒÙ‡Ø§ Ø¨ÛŒØ´ØªØ± Ù…ÛŒâ€ŒØ´Ù† ğŸ’£");
      }
      playBeep(900,0.1);
    }

    pauseBtn.onclick = ()=>{
      if(gameOver) return;
      isPaused = !isPaused;
      pauseBtn.textContent = isPaused ? "â–¶ï¸" : "â¸";
      flashHint(isPaused ? "Ø¨Ø§Ø²ÛŒ Ù…ØªÙˆÙ‚Ù Ø´Ø¯ â¸" : "Ø§Ø¯Ø§Ù…Ù‡ Ø¨Ø§Ø²ÛŒ â–¶ï¸");
    };

    soundBtn.onclick = ()=>{
      isMuted = !isMuted;
      soundBtn.textContent = isMuted ? "ğŸ”‡" : "ğŸ”Š";
    };

    retryBtn.onclick = ()=>{
      gameOverOverlay.style.display = "none";
      resetGame();
    };
    gameOverOverlay.addEventListener("click", e=>{
      if(e.target === gameOverOverlay){
        gameOverOverlay.style.display="none";
        resetGame();
      }
    });

    function update(){
      frame++;

      for(const b of blocks){
        if(b.type==="moving" && b.alive){
          b.x += b.vx;
          if(b.x<=padding || b.x+b.w>=canvas.width-padding) b.vx*=-1;
        }
      }

      for(const p of powerUps){
        if(!p.collected) p.y += 0.15;
      }

      let activeAny=false;
      for(const ball of balls){
        if(!ball.active && frame>=ball.delay) ball.active=true;
        if(!ball.active || ball.returned) continue;
        activeAny=true;

        ball.x += ball.vx;
        ball.y += ball.vy;

        trails.push({x:ball.x,y:ball.y,life:18});

        if(ball.x<=4 || ball.x>=canvas.width-4){
          ball.vx*=-1;
          ball.x = Math.max(4,Math.min(canvas.width-4,ball.x));
        }
        if(ball.y<=4){
          ball.vy*=-1;
          ball.y=4;
        }

        for(const b of blocks){
          if(!b.alive) continue;
          if(ball.x>b.x && ball.x<b.x+b.w && ball.y>b.y && ball.y<b.y+b.h){
            const ol = ball.x - b.x;
            const orr = (b.x+b.w)-ball.x;
            const ot = ball.y - b.y;
            const ob = (b.y+b.h)-ball.y;
            const minO = Math.min(ol,orr,ot,ob);
            if(minO===ol || minO===orr) ball.vx*=-1;
            else ball.vy*=-1;

            if(b.type==="ice" && b.hpExtra>0){
              b.hpExtra--;
              if(b.hpExtra===0){b.type="normal";b.color=pickColor(b.type,b.value);}
            }else if(b.type==="armor" && b.hpExtra>0){
              b.hpExtra--;
            }else{
              b.value -= damagePerHit;
            }

            if(b.value<=0){
              b.alive=false;
              score+=3;
              playBeep(430,0.08);
              if(b.type==="bomb"){
                shake=10;
                for(const nb of blocks){
                  if(!nb.alive||nb===b) continue;
                  const dx = Math.abs((nb.x+nb.w/2)-(b.x+b.w/2));
                  const dy = Math.abs((nb.y+nb.h/2)-(b.y+b.h/2));
                  if(dx<b.w*1.3 && dy<b.h*1.3){
                    nb.value -= damagePerHit*2;
                    if(nb.value<=0) nb.alive=false;
                  }
                }
              }
            }else{
              b.color = pickColor(b.type,b.value);
              score+=1;
            }

            if(score>bestScore) bestScore=score;
            updateLabels();
          }
        }

        for(const p of powerUps){
          if(p.collected) continue;
          const dx = ball.x - p.x;
          const dy = ball.y - p.y;
          if(Math.sqrt(dx*dx+dy*dy) < p.r+6){
            p.collected=true;
            applyPowerUp(p.type);
          }
        }

        if(ball.y>=canvas.height-6 && ball.vy>0){
          ball.returned=true;
        }
      }

      trails = trails.filter(t=>--t.life>0);
      blocks = blocks.filter(b=>b.alive);
      powerUps = powerUps.filter(p=>!p.collected && p.y<canvas.height-30);

      if(turnInProgress && !activeAny){
        turnInProgress = false;
        frame = 0;
        waves++;

        if(waves % 5 === 0){
          level++;
          flashHint("ğŸ‰ Ù…Ø±Ø­Ù„Ù‡ " + level + " Ø´Ø±ÙˆØ¹ Ø´Ø¯! Ø³Ø®Øªâ€ŒØªØ± Ø´Ø¯â€¦");
          playBeep(1100, 0.17);
        }

        moveBlocksDown();
        spawnRow();

        for(const b of blocks){
          if(b.y + b.h >= canvas.height - 20){
            playBeep(200, 0.4);
            if(score > bestScore) bestScore = score;
            updateLabels();
            gameOver = true;
            gameOverScoreText.textContent = "Ø§Ù…ØªÛŒØ§Ø² Ø´Ù…Ø§: " + score;
            gameOverBestText.textContent = "Ø¨Ù‡ØªØ±ÛŒÙ† Ø±Ú©ÙˆØ±Ø¯: " + bestScore;
            gameOverOverlay.style.display = "flex";
            return;
          }
        }

        updateLabels();
      }

      if(shake>0) shake--;
    }

    function draw(){
      const rnd = (min,max)=>Math.floor(Math.random()*(max-min+1))+min;
      const ox = shake? rnd(-shake,shake):0;
      const oy = shake? rnd(-shake,shake):0;
      ctx.save();
      ctx.translate(ox,oy);
      ctx.clearRect(-ox,-oy,canvas.width,canvas.height);

      const grad = ctx.createLinearGradient(0,0,0,canvas.height);
      grad.addColorStop(0,"#1a1450");
      grad.addColorStop(1,"#09051f");
      ctx.fillStyle=grad;
      ctx.fillRect(0,0,canvas.width,canvas.height);

      ctx.textAlign="center";
      ctx.textBaseline="middle";
      ctx.font="bold 14px sans-serif";
      for(const b of blocks){
        ctx.fillStyle="rgba(0,0,0,0.4)";
        ctx.fillRect(b.x+2,b.y+3,b.w,b.h);
        const g = ctx.createLinearGradient(b.x,b.y,b.x,b.y+b.h);
        g.addColorStop(0,b.color);
        g.addColorStop(1,"#ffffff22");
        ctx.fillStyle=g;
        ctx.fillRect(b.x,b.y,b.w,b.h);
        ctx.strokeStyle="#ffffff33";
        ctx.lineWidth=1;
        ctx.strokeRect(b.x+0.5,b.y+0.5,b.w-1,b.h-1);
        ctx.fillStyle="#fff";
        ctx.fillText(Math.max(1,Math.round(b.value)), b.x+b.w/2, b.y+b.h/2);
      }

      for(const p of powerUps){
        let colorOuter="#4cffb5";
        let text="B";
        if(p.type==="extraBall"){ colorOuter="#1abc9c"; text="+B"; }
        else if(p.type==="damageUp"){ colorOuter="#ff9f43"; text="DMG"; }
        else if(p.type==="bombUp"){ colorOuter="#9b59b6"; text="BOMB"; }

        ctx.beginPath();
        const g2 = ctx.createRadialGradient(p.x,p.y,2,p.x,p.y,p.r+4);
        g2.addColorStop(0,"#ffffff");
        g2.addColorStop(1,colorOuter);
        ctx.fillStyle=g2;
        ctx.arc(p.x,p.y,p.r,0,Math.PI*2);
        ctx.fill();
        ctx.strokeStyle="#ffffffaa";
        ctx.lineWidth=1;
        ctx.stroke();

        ctx.fillStyle="#003";
        ctx.font="9px sans-serif";
        ctx.fillText(text,p.x,p.y+0.5);
      }

      for(const t of trails){
        ctx.beginPath();
        const alpha = t.life/18;
        ctx.fillStyle=`rgba(255,255,255,${alpha})`;
        ctx.arc(t.x,t.y,3,0,Math.PI*2);
        ctx.fill();
      }

      ctx.fillStyle="#ffffff";
      for(const ball of balls){
        if(!ball.active || ball.returned) continue;
        ctx.beginPath();
        ctx.arc(ball.x,ball.y,4,0,Math.PI*2);
        ctx.fill();
      }

      ctx.beginPath();
      ctx.arc(baseX,baseY,6,0,Math.PI*2);
      ctx.fillStyle="#ffffff";
      ctx.fill();

      if(!turnInProgress && isAiming){
        ctx.setLineDash([5,5]);
        ctx.strokeStyle="#ffffffbb";
        ctx.beginPath();
        ctx.moveTo(baseX,baseY);
        ctx.lineTo(aimX,aimY);
        ctx.stroke();
        ctx.setLineDash([]);
      }

      ctx.restore();
    }

    function loop(){
      if(!isPaused && !gameOver){
        update();
      }
      draw();
      requestAnimationFrame(loop);
    }
    loop();
  </script>
</body>
</html>
